#!/bin/bash

# üéØ FADJMA Development Menu
# Menu interactif pour g√©rer l'environnement de d√©veloppement

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Fonction pour afficher le menu
show_menu() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë     üè• FADJMA Development Environment Menu üöÄ        ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${GREEN}üìä Services:${NC}"

    # V√©rifier le statut
    if [ -f ".backend.pid" ] && ps -p $(cat .backend.pid) > /dev/null 2>&1; then
        echo -e "   Backend:  ${GREEN}‚óè Running${NC}"
    else
        echo -e "   Backend:  ${RED}‚óã Stopped${NC}"
    fi

    if [ -f ".frontend.pid" ] && ps -p $(cat .frontend.pid) > /dev/null 2>&1; then
        echo -e "   Frontend: ${GREEN}‚óè Running${NC}"
    else
        echo -e "   Frontend: ${RED}‚óã Stopped${NC}"
    fi

    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${YELLOW}Commandes:${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}) üöÄ D√©marrer tout (backend + frontend)"
    echo -e "  ${GREEN}2${NC}) üõë Arr√™ter tout"
    echo -e "  ${GREEN}3${NC}) üìä Voir le statut"
    echo -e "  ${GREEN}4${NC}) üìã Voir les logs"
    echo ""
    echo -e "  ${BLUE}5${NC}) üîß D√©marrer backend uniquement"
    echo -e "  ${BLUE}6${NC}) ‚öõÔ∏è  D√©marrer frontend uniquement"
    echo ""
    echo -e "  ${MAGENTA}7${NC}) üîÑ Red√©marrer tout"
    echo -e "  ${MAGENTA}8${NC}) üßπ Nettoyer (logs + cache)"
    echo -e "  ${MAGENTA}9${NC}) üì¶ R√©installer d√©pendances"
    echo ""
    echo -e "  ${CYAN}10${NC}) üåê Ouvrir les URLs"
    echo -e "  ${CYAN}11${NC}) üìö Voir la documentation"
    echo ""
    echo -e "  ${BLUE}12${NC}) üê≥ Docker Management"
    echo ""
    echo -e "  ${RED}0${NC}) ‚ùå Quitter"
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
}

# Fonction pour attendre une touche
wait_key() {
    echo ""
    read -p "Appuyez sur Entr√©e pour continuer..."
}

# Fonction pour d√©marrer le backend uniquement
start_backend() {
    echo -e "${BLUE}üîß D√©marrage du backend...${NC}"
    cd backend
    npm run dev > ../logs/backend-dev.log 2>&1 &
    echo $! > ../.backend.pid
    cd ..
    echo -e "${GREEN}‚úì Backend d√©marr√© (PID: $(cat .backend.pid))${NC}"
    wait_key
}

# Fonction pour d√©marrer le frontend uniquement
start_frontend() {
    echo -e "${MAGENTA}‚öõÔ∏è  D√©marrage du frontend...${NC}"
    cd frontend
    export BROWSER=none
    npm start > ../logs/frontend-dev.log 2>&1 &
    echo $! > ../.frontend.pid
    cd ..
    echo -e "${GREEN}‚úì Frontend d√©marr√© (PID: $(cat .frontend.pid))${NC}"
    wait_key
}

# Fonction pour nettoyer
clean_env() {
    echo -e "${YELLOW}üßπ Nettoyage de l'environnement...${NC}"

    echo -e "Suppression des logs..."
    rm -rf logs/*.log

    echo -e "Suppression des fichiers PID..."
    rm -f .backend.pid .frontend.pid

    echo -e "Suppression du cache npm..."
    npm cache clean --force

    echo -e "${GREEN}‚úì Nettoyage termin√©${NC}"
    wait_key
}

# Fonction pour r√©installer les d√©pendances
reinstall_deps() {
    echo -e "${YELLOW}üì¶ R√©installation des d√©pendances...${NC}"

    echo -e "\n${BLUE}Backend...${NC}"
    cd backend
    rm -rf node_modules package-lock.json
    npm install
    cd ..

    echo -e "\n${MAGENTA}Frontend...${NC}"
    cd frontend
    rm -rf node_modules package-lock.json
    npm install
    cd ..

    echo -e "\n${GREEN}‚úì R√©installation termin√©e${NC}"
    wait_key
}

# Fonction pour ouvrir les URLs
open_urls() {
    echo -e "${CYAN}üåê Ouverture des URLs...${NC}"

    if command -v xdg-open &> /dev/null; then
        xdg-open http://localhost:3000 2>/dev/null
        xdg-open http://localhost:5000/api/health 2>/dev/null
    elif command -v open &> /dev/null; then
        open http://localhost:3000
        open http://localhost:5000/api/health
    else
        echo -e "${YELLOW}URLs:${NC}"
        echo -e "  Frontend: http://localhost:3000"
        echo -e "  Backend:  http://localhost:5000"
    fi

    wait_key
}

# Fonction pour voir la documentation
show_docs() {
    clear
    echo -e "${CYAN}üìö Documentation${NC}"
    echo ""
    echo -e "${YELLOW}Fichiers disponibles:${NC}"
    echo ""
    echo "  1. README.md - Vue d'ensemble"
    echo "  2. DEVELOPMENT.md - Guide de d√©veloppement"
    echo "  3. PLAN_ARCHITECTURE_COMPLET.md - Architecture"
    echo "  4. docs/CAHIER_DES_CHARGES_FADJMA.md - Cahier des charges"
    echo "  5. docs/PLAN_PHASE_1_Q1_2025.md - Roadmap Phase 1"
    echo ""
    echo -e "${YELLOW}URLs utiles:${NC}"
    echo ""
    echo "  - Frontend: http://localhost:3000"
    echo "  - Backend API: http://localhost:5000/api"
    echo "  - Health Check: http://localhost:5000/api/health"
    echo ""
    wait_key
}

# ============================================
# üê≥ DOCKER MANAGEMENT FUNCTIONS
# ============================================

# Fonction pour v√©rifier Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}‚ùå Docker n'est pas install√©${NC}"
        echo -e "${YELLOW}Installation requise: https://docs.docker.com/get-docker/${NC}"
        return 1
    fi

    if ! command -v docker-compose &> /dev/null; then
        echo -e "${RED}‚ùå Docker Compose n'est pas install√©${NC}"
        echo -e "${YELLOW}Installation requise: https://docs.docker.com/compose/install/${NC}"
        return 1
    fi

    if ! sudo docker info &> /dev/null; then
        echo -e "${RED}‚ùå Docker daemon n'est pas d√©marr√©${NC}"
        echo -e "${YELLOW}D√©marrez Docker Desktop ou le service Docker${NC}"
        return 1
    fi

    return 0
}

# Fonction pour v√©rifier le statut Docker
docker_status() {
    echo -e "${CYAN}üìä Statut Docker:${NC}"
    echo ""

    if sudo docker-compose ps 2>/dev/null | grep -q "Up"; then
        echo -e "${GREEN}Services Docker actifs:${NC}"
        sudo docker-compose ps
    else
        echo -e "${YELLOW}Aucun service Docker actif${NC}"
    fi
    echo ""
}

# Fonction pour configurer .env si n√©cessaire
setup_docker_env() {
    if [ ! -f ".env" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Fichier .env non trouv√©${NC}"
        read -p "Copier .env.example vers .env ? [O/n]: " copy_env

        if [ "$copy_env" != "n" ] && [ "$copy_env" != "N" ]; then
            cp .env.example .env
            echo -e "${GREEN}‚úì Fichier .env cr√©√©${NC}"
            echo -e "${YELLOW}‚ö†Ô∏è  IMPORTANT: √âditez .env avec vos credentials Hedera${NC}"
            read -p "Voulez-vous √©diter .env maintenant ? [O/n]: " edit_now

            if [ "$edit_now" != "n" ] && [ "$edit_now" != "N" ]; then
                ${EDITOR:-nano} .env
            fi
        else
            echo -e "${RED}‚ùå .env requis pour Docker${NC}"
            return 1
        fi
    fi
    return 0
}

# Fonction pour d√©marrer Docker
docker_start() {
    echo -e "${BLUE}üê≥ D√©marrage des services Docker...${NC}"
    echo ""

    if ! check_docker; then
        wait_key
        return 1
    fi

    if ! setup_docker_env; then
        wait_key
        return 1
    fi

    echo -e "${CYAN}Lancement sudo docker-compose up -d...${NC}"
    sudo docker-compose up -d

    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úì Services Docker d√©marr√©s${NC}"
        echo ""
        sudo docker-compose ps
        echo ""
        echo -e "${YELLOW}Attendez ~40 secondes pour le health check du backend...${NC}"
        echo ""
        echo -e "${CYAN}URLs disponibles:${NC}"
        echo -e "  Frontend: ${GREEN}http://localhost:3000${NC}"
        echo -e "  Backend:  ${GREEN}http://localhost:5000${NC}"
        echo -e "  Health:   ${GREEN}http://localhost:5000/api/health${NC}"
    else
        echo -e "${RED}‚ùå Erreur lors du d√©marrage Docker${NC}"
    fi

    wait_key
}

# Fonction pour arr√™ter Docker
docker_stop() {
    echo -e "${YELLOW}üõë Arr√™t des services Docker...${NC}"

    sudo docker-compose down

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì Services Docker arr√™t√©s${NC}"
    else
        echo -e "${RED}‚ùå Erreur lors de l'arr√™t${NC}"
    fi

    wait_key
}

# Fonction pour les logs Docker
docker_logs() {
    clear
    echo -e "${CYAN}üìã Logs Docker${NC}"
    echo ""
    echo "  1. Backend"
    echo "  2. Frontend"
    echo "  3. Les deux (temps r√©el)"
    echo "  4. Retour"
    echo ""
    read -p "Choix [1-4]: " log_choice

    case $log_choice in
        1)
            clear
            echo -e "${CYAN}Logs Backend (Ctrl+C pour quitter):${NC}"
            sudo docker-compose logs -f backend
            ;;
        2)
            clear
            echo -e "${CYAN}Logs Frontend (Ctrl+C pour quitter):${NC}"
            sudo docker-compose logs -f frontend
            ;;
        3)
            clear
            echo -e "${CYAN}Logs Temps R√©el (Ctrl+C pour quitter):${NC}"
            sudo docker-compose logs -f
            ;;
        4)
            return
            ;;
    esac
}

# Fonction pour initialiser la base de donn√©es
docker_init_db() {
    echo -e "${BLUE}üóÑÔ∏è  Initialisation de la base de donn√©es...${NC}"
    echo ""

    if ! sudo docker-compose ps | grep -q "backend.*Up"; then
        echo -e "${RED}‚ùå Le service backend doit √™tre d√©marr√©${NC}"
        wait_key
        return 1
    fi

    echo -e "${CYAN}√âtape 1/2: Initialisation SQLite...${NC}"
    sudo docker-compose exec backend npm run init:sqlite

    echo ""
    echo -e "${CYAN}√âtape 2/2: Seed des donn√©es...${NC}"
    echo ""
    echo "  1. Seed complet (12 utilisateurs + dossiers)"
    echo "  2. Seed minimal (8 utilisateurs de base)"
    echo ""
    read -p "Choix [1-2]: " seed_choice

    case $seed_choice in
        1)
            sudo docker-compose exec backend npm run seed:full
            ;;
        2)
            sudo docker-compose exec backend npm run seed:clean
            ;;
    esac

    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úì Base de donn√©es initialis√©e${NC}"
        echo ""
        echo -e "${CYAN}Comptes de test disponibles:${NC}"
        echo -e "  M√©decin:    ${YELLOW}dr.martin@fadjma.com${NC}         / Demo2024!"
        echo -e "  Patient:    ${YELLOW}jean.dupont@demo.com${NC}         / Demo2024!"
        echo -e "  Pharmacien: ${YELLOW}pharmacie.centrale@fadjma.com${NC} / Demo2024!"
        echo -e "  Admin:      ${YELLOW}admin@fadjma.com${NC}             / Admin2024!"
    else
        echo -e "${RED}‚ùå Erreur lors de l'initialisation${NC}"
    fi

    wait_key
}

# Fonction pour rebuild les images
docker_rebuild() {
    echo -e "${YELLOW}üî® Rebuild des images Docker...${NC}"
    echo ""
    echo -e "${RED}‚ö†Ô∏è  Ceci va arr√™ter les services et reconstruire les images${NC}"
    read -p "Continuer ? [o/N]: " confirm

    if [ "$confirm" = "o" ] || [ "$confirm" = "O" ]; then
        echo ""
        echo -e "${CYAN}Arr√™t des services...${NC}"
        sudo docker-compose down

        echo ""
        echo -e "${CYAN}Rebuild des images...${NC}"
        sudo docker-compose build --no-cache

        echo ""
        echo -e "${CYAN}Red√©marrage des services...${NC}"
        sudo docker-compose up -d

        if [ $? -eq 0 ]; then
            echo ""
            echo -e "${GREEN}‚úì Images reconstruites et services red√©marr√©s${NC}"
        else
            echo -e "${RED}‚ùå Erreur lors du rebuild${NC}"
        fi
    else
        echo -e "${YELLOW}Op√©ration annul√©e${NC}"
    fi

    wait_key
}

# Fonction pour nettoyer Docker
docker_clean() {
    echo -e "${YELLOW}üßπ Nettoyage Docker${NC}"
    echo ""
    echo -e "${RED}‚ö†Ô∏è  OPTIONS DE NETTOYAGE:${NC}"
    echo ""
    echo "  1. Arr√™ter les services (docker-compose down)"
    echo "  2. Arr√™ter + Supprimer volumes (‚ö†Ô∏è  PERTE DONN√âES DB)"
    echo "  3. Arr√™ter + Supprimer volumes + images"
    echo "  4. Nettoyage complet Docker syst√®me (prune)"
    echo "  5. Annuler"
    echo ""
    read -p "Choix [1-5]: " clean_choice

    case $clean_choice in
        1)
            echo ""
            echo -e "${CYAN}Arr√™t des services...${NC}"
            sudo docker-compose down
            echo -e "${GREEN}‚úì Services arr√™t√©s${NC}"
            ;;
        2)
            echo ""
            echo -e "${RED}‚ö†Ô∏è  ATTENTION: Toutes les donn√©es de la base seront perdues!${NC}"
            read -p "√ätes-vous s√ªr ? Tapez 'yes' pour confirmer: " confirm
            if [ "$confirm" = "yes" ]; then
                echo -e "${CYAN}Suppression des services et volumes...${NC}"
                sudo docker-compose down -v
                echo -e "${GREEN}‚úì Services et volumes supprim√©s${NC}"
            else
                echo -e "${YELLOW}Op√©ration annul√©e${NC}"
            fi
            ;;
        3)
            echo ""
            echo -e "${RED}‚ö†Ô∏è  Suppression volumes + images!${NC}"
            read -p "√ätes-vous s√ªr ? Tapez 'yes' pour confirmer: " confirm
            if [ "$confirm" = "yes" ]; then
                echo -e "${CYAN}Suppression compl√®te...${NC}"
                sudo docker-compose down -v --rmi all
                echo -e "${GREEN}‚úì Services, volumes et images supprim√©s${NC}"
            else
                echo -e "${YELLOW}Op√©ration annul√©e${NC}"
            fi
            ;;
        4)
            echo ""
            echo -e "${CYAN}Nettoyage syst√®me Docker (containers, images, volumes non utilis√©s)...${NC}"
            sudo docker system prune -a --volumes
            echo -e "${GREEN}‚úì Nettoyage syst√®me termin√©${NC}"
            ;;
        5)
            echo -e "${YELLOW}Op√©ration annul√©e${NC}"
            ;;
    esac

    wait_key
}

# Fonction pour acc√©der au shell des containers
docker_shell() {
    echo -e "${CYAN}üêö Acc√®s Shell${NC}"
    echo ""
    echo "  1. Backend shell (sh)"
    echo "  2. Frontend shell (sh)"
    echo "  3. Backend - SQLite CLI"
    echo "  4. Retour"
    echo ""
    read -p "Choix [1-4]: " shell_choice

    case $shell_choice in
        1)
            echo -e "${CYAN}Connexion au backend...${NC}"
            sudo docker-compose exec backend sh
            ;;
        2)
            echo -e "${CYAN}Connexion au frontend...${NC}"
            sudo docker-compose exec frontend sh
            ;;
        3)
            echo -e "${CYAN}SQLite CLI (tapez .quit pour quitter)...${NC}"
            sudo docker-compose exec backend sqlite3 /app/data/database.sqlite
            ;;
        4)
            return
            ;;
    esac

    wait_key
}

# Fonction Quick Start pour les juges
docker_quick_start() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë     üéØ QUICK START - Ready in 3 minutes! üöÄ         ‚ïë${NC}"
    echo -e "${CYAN}‚ïë     Perfect for Hedera Hackathon Judges             ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""

    echo -e "${YELLOW}This will automatically:${NC}"
    echo "  ‚úì Check Docker prerequisites"
    echo "  ‚úì Configure environment (.env)"
    echo "  ‚úì Start Docker services"
    echo "  ‚úì Initialize SQLite database"
    echo "  ‚úì Load test data (12 users + medical records)"
    echo "  ‚úì Open application in browser"
    echo ""
    echo -e "${GREEN}Total time: ~3 minutes${NC}"
    echo ""
    read -p "Press Enter to start, or 'q' to cancel: " confirm

    if [ "$confirm" = "q" ] || [ "$confirm" = "Q" ]; then
        return
    fi

    # √âtape 1: V√©rifications
    echo ""
    echo -e "${CYAN}[1/6] Checking Docker prerequisites...${NC}"
    if ! check_docker; then
        echo -e "${RED}‚ùå Docker prerequisites not met. Please install Docker first.${NC}"
        wait_key
        return 1
    fi
    echo -e "${GREEN}‚úì Docker is ready!${NC}"
    sleep 1

    # √âtape 2: Configuration .env
    echo ""
    echo -e "${CYAN}[2/6] Configuring environment...${NC}"
    if [ ! -f ".env" ]; then
        echo -e "${YELLOW}Creating .env from .env.example...${NC}"
        cp .env.example .env
        echo -e "${GREEN}‚úì .env created!${NC}"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  IMPORTANT: Default Hedera Testnet credentials are configured.${NC}"
        echo -e "${YELLOW}   For production, edit .env with your own credentials.${NC}"
    else
        echo -e "${GREEN}‚úì .env already exists${NC}"
    fi
    sleep 1

    # √âtape 3: D√©marrage Docker
    echo ""
    echo -e "${CYAN}[3/6] Starting Docker services...${NC}"
    sudo docker-compose up -d

    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Failed to start Docker services${NC}"
        wait_key
        return 1
    fi

    echo -e "${GREEN}‚úì Docker services started!${NC}"
    echo ""
    sudo docker-compose ps
    echo ""
    echo -e "${YELLOW}Waiting 45 seconds for backend health check...${NC}"

    # Attente avec progression
    for i in {45..1}; do
        echo -ne "\rWaiting... ${i}s  "
        sleep 1
    done
    echo ""
    echo -e "${GREEN}‚úì Services should be healthy now${NC}"
    sleep 1

    # √âtape 4: V√©rifier que le backend est up
    echo ""
    echo -e "${CYAN}[4/6] Verifying backend is ready...${NC}"
    if ! sudo docker-compose ps | grep -q "backend.*Up"; then
        echo -e "${RED}‚ùå Backend is not running${NC}"
        echo -e "${YELLOW}Check logs with: sudo docker-compose logs backend${NC}"
        wait_key
        return 1
    fi
    echo -e "${GREEN}‚úì Backend is running!${NC}"
    sleep 1

    # √âtape 5: Initialisation base de donn√©es
    echo ""
    echo -e "${CYAN}[5/6] Initializing database with test data...${NC}"

    echo -e "${BLUE}  ‚Üí Creating SQLite tables...${NC}"
    sudo docker-compose exec -T backend npm run init:sqlite

    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Failed to initialize SQLite${NC}"
        wait_key
        return 1
    fi

    echo ""
    echo -e "${BLUE}  ‚Üí Loading test data (12 users + medical records)...${NC}"
    sudo docker-compose exec -T backend npm run seed:full

    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Failed to seed database${NC}"
        wait_key
        return 1
    fi

    echo -e "${GREEN}‚úì Database ready with test data!${NC}"
    sleep 1

    # √âtape 6: Affichage des informations finales
    echo ""
    echo -e "${CYAN}[6/6] All done! üéâ${NC}"
    echo ""
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë           ‚úÖ FADJMA IS READY FOR TESTING!             ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""

    echo -e "${GREEN}üåê Application URLs:${NC}"
    echo -e "   Frontend:    ${YELLOW}http://localhost:3000${NC}"
    echo -e "   Backend API: ${YELLOW}http://localhost:5000/api${NC}"
    echo -e "   Health:      ${YELLOW}http://localhost:5000/api/health${NC}"
    echo ""

    echo -e "${GREEN}üë§ Test Accounts (Password: Demo2024!):${NC}"
    echo -e "   Doctor:      ${YELLOW}dr.martin@fadjma.com${NC}"
    echo -e "   Patient:     ${YELLOW}jean.dupont@demo.com${NC}"
    echo -e "   Pharmacist:  ${YELLOW}pharmacie.centrale@fadjma.com${NC}"
    echo -e "   Admin:       ${YELLOW}admin@fadjma.com${NC} (Password: Admin2024!)"
    echo ""

    echo -e "${GREEN}‚õìÔ∏è  Hedera Blockchain Integration:${NC}"
    echo -e "   Network:     ${YELLOW}Testnet${NC}"
    echo -e "   Account:     ${YELLOW}0.0.6164695${NC} (EC25519)"
    echo -e "   Account:     ${YELLOW}0.0.6089195${NC} (ECDSA)"
    echo -e "   Topic:       ${YELLOW}0.0.6854064${NC}"
    echo -e "   Verify:      ${YELLOW}https://hashscan.io/testnet/topic/0.0.6854064${NC}"
    echo ""

    echo -e "${GREEN}üìä What's included:${NC}"
    echo "   ‚úì 12 test users (doctors, patients, pharmacists)"
    echo "   ‚úì 11 medical records with Hedera anchoring"
    echo "   ‚úì 9 prescriptions with unique matricules"
    echo "   ‚úì SQLite database fully configured"
    echo "   ‚úì All Hedera transactions verified on Testnet"
    echo ""

    echo -e "${CYAN}üé¨ Quick Demo Path:${NC}"
    echo "   1. Open http://localhost:3000"
    echo "   2. Login as doctor: dr.martin@fadjma.com / Demo2024!"
    echo "   3. View existing medical records"
    echo "   4. Create a new medical record ‚Üí See Hedera anchoring"
    echo "   5. Verify integrity ‚Üí Check on HashScan"
    echo ""

    # Proposer d'ouvrir le navigateur
    read -p "Open application in browser now? [Y/n]: " open_browser

    if [ "$open_browser" != "n" ] && [ "$open_browser" != "N" ]; then
        echo ""
        echo -e "${CYAN}Opening browser...${NC}"
        sleep 1

        if command -v xdg-open &> /dev/null; then
            xdg-open http://localhost:3000 2>/dev/null &
            xdg-open https://hashscan.io/testnet/topic/0.0.6854064 2>/dev/null &
        elif command -v open &> /dev/null; then
            open http://localhost:3000 &
            open https://hashscan.io/testnet/topic/0.0.6854064 &
        fi

        echo -e "${GREEN}‚úì Browser tabs opened!${NC}"
    fi

    echo ""
    echo -e "${YELLOW}üìã Useful commands:${NC}"
    echo "   View logs:     sudo docker-compose logs -f"
    echo "   Stop services: sudo docker-compose down"
    echo "   Restart:       sudo docker-compose restart"
    echo ""

    wait_key
}

# Menu Docker principal
docker_menu() {
    while true; do
        clear
        echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${CYAN}‚ïë          üê≥ FADJMA Docker Management üê≥              ‚ïë${NC}"
        echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""

        # Afficher le statut
        docker_status

        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo -e "${GREEN}üéØ FOR JUDGES / QUICK START:${NC}"
        echo ""
        echo -e "  ${GREEN}‚òÖ${NC}) ${GREEN}üöÄ QUICK START - Deploy Everything in 3 minutes!${NC}"
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo -e "${YELLOW}Manual Configuration (Advanced):${NC}"
        echo ""
        echo -e "  ${GREEN}1${NC}) üöÄ Start Docker services"
        echo -e "  ${GREEN}2${NC}) üõë Stop Docker services"
        echo -e "  ${GREEN}3${NC}) üîÑ Restart Docker"
        echo ""
        echo -e "  ${BLUE}4${NC}) üóÑÔ∏è  Initialize database + Seed"
        echo -e "  ${BLUE}5${NC}) üêö Access Shell / SQLite CLI"
        echo ""
        echo -e "  ${MAGENTA}6${NC}) üìã View logs"
        echo -e "  ${MAGENTA}7${NC}) üî® Rebuild images"
        echo -e "  ${MAGENTA}8${NC}) üßπ Clean Docker"
        echo ""
        echo -e "  ${CYAN}9${NC}) üìä Detailed status"
        echo -e "  ${CYAN}10${NC}) üìö Docker guide"
        echo ""
        echo -e "  ${RED}0${NC}) ‚Üê Back to main menu"
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        read -p "Choose option [0-10, ‚òÖ for Quick Start]: " docker_choice

        case $docker_choice in
            "‚òÖ"|"*"|"q"|"Q"|"quick"|"QUICK")
                docker_quick_start
                ;;
            1)
                clear
                docker_start
                ;;
            2)
                clear
                docker_stop
                ;;
            3)
                clear
                echo -e "${YELLOW}üîÑ Red√©marrage Docker...${NC}"
                docker-compose restart
                echo -e "${GREEN}‚úì Services red√©marr√©s${NC}"
                wait_key
                ;;
            4)
                clear
                docker_init_db
                ;;
            5)
                clear
                docker_shell
                ;;
            6)
                docker_logs
                ;;
            7)
                clear
                docker_rebuild
                ;;
            8)
                clear
                docker_clean
                ;;
            9)
                clear
                echo -e "${CYAN}üìä Statut D√©taill√© Docker${NC}"
                echo ""
                echo -e "${YELLOW}Services:${NC}"
                sudo docker-compose ps
                echo ""
                echo -e "${YELLOW}Images:${NC}"
                sudo docker images | grep fadjma
                echo ""
                echo -e "${YELLOW}Volumes:${NC}"
                sudo docker volume ls | grep fadjma
                echo ""
                echo -e "${YELLOW}R√©seau:${NC}"
                sudo docker network ls | grep fadjma
                echo ""
                wait_key
                ;;
            10)
                clear
                echo -e "${CYAN}üìö Guide Docker FADJMA${NC}"
                echo ""
                echo -e "${YELLOW}D√©marrage rapide (5 minutes):${NC}"
                echo ""
                echo "  1. V√©rifier Docker install√© et d√©marr√©"
                echo "  2. Copier .env.example vers .env"
                echo "  3. √âditer .env avec vos credentials Hedera"
                echo "  4. sudo docker-compose up -d"
                echo "  5. sudo docker-compose exec backend npm run init:sqlite"
                echo "  6. sudo docker-compose exec backend npm run seed:full"
                echo "  7. Acc√©der http://localhost:3000"
                echo ""
                echo -e "${YELLOW}Commandes utiles:${NC}"
                echo ""
                echo "  sudo docker-compose ps              # Voir les services"
                echo "  sudo docker-compose logs -f         # Logs temps r√©el"
                echo "  sudo docker-compose exec backend sh # Shell backend"
                echo "  sudo docker-compose down -v         # Tout supprimer"
                echo ""
                echo -e "${YELLOW}Documentation compl√®te:${NC}"
                echo "  - DOCKER_QUICK_TEST.md"
                echo "  - docs/DOCKER_SETUP.md"
                echo "  - docs/DOCKER_SQLITE_MIGRATION_SUMMARY.md"
                echo ""
                wait_key
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}Option invalide${NC}"
                wait_key
                ;;
        esac
    done
}

# ============================================
# MAIN MENU LOOP
# ============================================

# Boucle principale
while true; do
    show_menu
    read -p "Choisissez une option [0-12]: " choice

    case $choice in
        1)
            clear
            ./start-dev.sh
            ;;
        2)
            clear
            ./stop-dev.sh
            wait_key
            ;;
        3)
            clear
            ./status-dev.sh
            wait_key
            ;;
        4)
            clear
            echo -e "${CYAN}üìã Logs${NC}"
            echo ""
            echo "  1. Backend"
            echo "  2. Frontend"
            echo "  3. Les deux"
            echo ""
            read -p "Choix [1-3]: " log_choice
            case $log_choice in
                1) ./logs-dev.sh backend ;;
                2) ./logs-dev.sh frontend ;;
                3) ./logs-dev.sh ;;
            esac
            ;;
        5)
            clear
            start_backend
            ;;
        6)
            clear
            start_frontend
            ;;
        7)
            clear
            echo -e "${YELLOW}üîÑ Red√©marrage...${NC}"
            ./stop-dev.sh
            sleep 2
            ./start-dev.sh
            ;;
        8)
            clear
            clean_env
            ;;
        9)
            clear
            reinstall_deps
            ;;
        10)
            clear
            open_urls
            ;;
        11)
            show_docs
            ;;
        12)
            clear
            docker_menu
            ;;
        0)
            clear
            echo -e "${GREEN}üëã Au revoir!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}Option invalide${NC}"
            wait_key
            ;;
    esac
done
